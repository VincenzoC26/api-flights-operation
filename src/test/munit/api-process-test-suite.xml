<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit" xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd">
	<munit:config name="api-process-test-suite.xml" />
	<munit:test name="nuovoTest2" doc:id="3c0a6cfe-f566-4916-956d-f110a2404772" >
		<munit:execution >
			<set-payload value='#["Valore"]' doc:name="Set Payload" doc:id="8390745c-2d5f-408a-99ff-4814f86276be" />
		</munit:execution>
		<munit:validation >
			<logger level="INFO" doc:name="Logger" doc:id="4304b00b-6958-4cab-8765-c6201ea7b179" />
		</munit:validation>
	</munit:test>
	<munit:test name="api-process-test-correctQueryParams" doc:id="322a3fb9-ba17-49b9-9f67-b8aa2d57f033" >
		<munit:behavior >
			<munit-tools:spy doc:name="Spy" doc:id="c7537094-b088-403b-89e8-1512463b1cd9" processor="ee:transform">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="f0b28005-23d3-48a5-b0e9-bfadb11c6966" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:before-call >
					<munit-tools:assert-that doc:name="Assert that vars.destination is null" doc:id="9e4ae74d-af71-4283-9abd-46a2bdc1485c" expression="#[vars.destination]" is="#[MunitTools::nullValue()]"/>
				</munit-tools:before-call>
				<munit-tools:after-call >
					<munit-tools:assert-that doc:name="Assert that vars.destination is not null" doc:id="01242406-00f7-499b-a9c0-0144b3809f97" expression="#[vars.destination]" is="#[MunitTools::notNullValue()]"/>
				</munit-tools:after-call>
			</munit-tools:spy>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="vars.destination = 'LAX'" doc:id="43b0a3d3-c481-4afd-9f3e-032cadf88efb" >
				<munit:attributes value="#[{ method : 'GET', queryParams : { destination : 'LAX'}}]" />
			</munit:set-event>
			<flow-ref doc:name="getTotalPrice" doc:id="196ef0d7-919a-4002-96a8-1933412919ca" name="getTotalPrice"/>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-equals doc:name="vars.destination == LAX" doc:id="37759e5e-0364-436d-93d5-6121878517a8" actual="#[vars.destination]" expected="#['LAX']"/>
			<logger level="INFO" doc:name="Logger" doc:id="238a31cb-5811-4d2a-b98a-a705fee7204d" message="#[vars.destination]"/>
		</munit:validation>
	</munit:test>
	<munit:test name="api-process-test-correctOutput" doc:id="2b720717-064c-463e-8c30-98e0fdc3dae4" >
		<munit:behavior >
			<munit-tools:mock-when doc:name="getFlights" doc:id="f4f0152c-e473-47c7-85df-7a89e1cfee2e" processor="flow-ref">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="b84cfa64-eec2-424d-860b-195be8989557" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:then-return >
					<munit-tools:payload value='#[output application/json&#10;---&#10;[&#10;    {&#10;        "ID": 1,&#10;        "code": "rree0001",&#10;        "price": 541,&#10;        "departureDate": "2016-01-20T00:00:00",&#10;        "origin": "MUA",&#10;        "destination": "LAX",&#10;        "emptySeats": 0,&#10;        "plane": {&#10;            "type": "Boeing 787",&#10;            "totalSeats": 200&#10;        }&#10;    },&#10;    {&#10;        "ID": 3,&#10;        "code": "ffee0192",&#10;        "price": 300,&#10;        "departureDate": "2016-01-20T00:00:00",&#10;        "origin": "MUA",&#10;        "destination": "LAX",&#10;        "emptySeats": 0,&#10;        "plane": {&#10;            "type": "Boeing 777",&#10;            "totalSeats": 300&#10;        }&#10;    },&#10;    {&#10;        "ID": 10,&#10;        "code": "eefd4511",&#10;        "price": 900,&#10;        "departureDate": "2016-01-15T00:00:00",&#10;        "origin": "MUA",&#10;        "destination": "LAX",&#10;        "emptySeats": 100,&#10;        "plane": {&#10;            "type": "Boeing 777",&#10;            "totalSeats": 300&#10;        }&#10;    }&#10;]]' mediaType="application/json" />
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="queryParams.destination = LAX" doc:id="2430697a-cf0a-4ed2-a888-7aa22c98bdba" >
				<munit:attributes value="#[{ method : 'GET', queryParams : { destination : 'LAX'}}]" />
			</munit:set-event>
			<flow-ref doc:name="getTotalPrice" doc:id="d4a8306d-8268-4e11-96ff-b65d8292b438" name="getTotalPrice"/>
		</munit:execution>
		<munit:validation>
			<munit-tools:assert-equals doc:name="correct output" doc:id="1f2097b6-0c73-4691-b27e-d95ccf30d524" actual="#[payload]" expected='#[output application/json&#10;---&#10;&#10;{&#10;  "destination": "LAX",&#10;  "planes": [&#10;    {&#10;      "type": "Boeing 777",&#10;      "pricePerSeat": "270000\$"&#10;    },&#10;    {&#10;      "type": "Boeing 787",&#10;      "pricePerSeat": "108200\$"&#10;    }&#10;  ]&#10;}]'/>
		</munit:validation>
	</munit:test>
	<munit:test name="api-process-test-getFlights" doc:id="e8e8badc-0b42-4e74-ad85-c66b83850ee1" >
		<munit:behavior >
			<munit-tools:spy doc:name="Spy" doc:id="d3997062-0ad1-4b63-abbf-8df56e0e9aac" processor="http:request">
				<munit-tools:with-attributes >
					<munit-tools:with-attribute whereValue="f0216e49-ae7f-48ae-8d79-7e72eae1fc14" attributeName="doc:id" />
				</munit-tools:with-attributes>
				<munit-tools:before-call >
					<munit-tools:assert-that doc:name="payload is null" doc:id="ef97bb34-3d2f-4277-8310-9d14b3e8fe2b" expression="#[payload]" is="#[MunitTools::nullValue()]"/>
				</munit-tools:before-call>
				<munit-tools:after-call >
					<munit-tools:assert-that doc:name="payload not null" doc:id="790f8e34-6dbe-415d-b657-07f339f8b960" expression="#[payload]" is="#[MunitTools::notNullValue()]"/>
				</munit-tools:after-call>
			</munit-tools:spy>
		</munit:behavior>
		<munit:execution >
			<munit:set-event doc:name="Set Event" doc:id="ccd12307-2e26-47fb-8360-e23fe0ddd09b" >
				<munit:variables >
					<munit:variable key="destination" value="LAX" />
				</munit:variables>
			</munit:set-event>
			<flow-ref doc:name="getFlights" doc:id="22c806cd-182f-4245-89e9-1c848deb2fc3" name="getFlights"/>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-equals doc:name="correct output" doc:id="62b03c5b-69f2-40fe-a68c-de551017583f" actual="#[payload]" expected='#[output application/json&#10;---&#10;[&#10;    {&#10;        "ID": 1,&#10;        "code": "rree0001",&#10;        "price": 541,&#10;        "departureDate": "2016-01-20T00:00:00",&#10;        "origin": "MUA",&#10;        "destination": "LAX",&#10;        "emptySeats": 0,&#10;        "plane": {&#10;            "type": "Boeing 787",&#10;            "totalSeats": 200&#10;        }&#10;    },&#10;    {&#10;        "ID": 3,&#10;        "code": "ffee0192",&#10;        "price": 300,&#10;        "departureDate": "2016-01-20T00:00:00",&#10;        "origin": "MUA",&#10;        "destination": "LAX",&#10;        "emptySeats": 0,&#10;        "plane": {&#10;            "type": "Boeing 777",&#10;            "totalSeats": 300&#10;        }&#10;    },&#10;    {&#10;        "ID": 10,&#10;        "code": "eefd4511",&#10;        "price": 900,&#10;        "departureDate": "2016-01-15T00:00:00",&#10;        "origin": "MUA",&#10;        "destination": "LAX",&#10;        "emptySeats": 100,&#10;        "plane": {&#10;            "type": "Boeing 777",&#10;            "totalSeats": 300&#10;        }&#10;    }&#10;]]'/>
		</munit:validation>
	</munit:test>
	<munit:test name="api-process-test-postSubtraction" doc:id="210e9b80-4f71-4937-b646-5652ae715a64" >
		<munit:execution >
			<munit:set-event doc:name="Set Event" doc:id="504276e6-27a9-4d51-94b6-3506648852cd" >
				<munit:variables >
					<munit:variable key="totalSeats" value="200" />
					<munit:variable key="emptySeats" value="20" />
				</munit:variables>
			</munit:set-event>
			<flow-ref doc:name="postSubtraction" doc:id="7488c139-da66-4582-86e1-bf9060f0cbce" name="postSubtraction"/>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-equals doc:name="Assert equals" doc:id="e5f6b4b3-8172-4171-b0d8-9d1ed6e2dfb8" actual="#[payload.result]" expected="#[180]"/>
		</munit:validation>
	</munit:test>
	<munit:test name="api-process-test-postMultiply" doc:id="b1bb3b84-b65d-406d-93db-db70bd5bfb9e" >
		<munit:execution >
			<munit:set-event doc:name="Set Event" doc:id="55c77e4c-6d36-4b13-9ec0-db20232624ce" >
				<munit:payload value='#[output application/json&#10;---&#10;{&#10;	"result": 10&#10;}]' />
				<munit:variables >
					<munit:variable key="price" value="10" />
				</munit:variables>
			</munit:set-event>
			<flow-ref doc:name="postMultiply" doc:id="9f410404-30db-428f-8293-a2a4f9dcdd5f" name="postMultiply"/>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-equals doc:name="Assert equals" doc:id="22c35f24-8631-45e6-bb07-9cc5855c8b23" actual="#[payload.result]" expected="#[100]"/>
		</munit:validation>
	</munit:test>


</mule>
